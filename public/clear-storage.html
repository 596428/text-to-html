<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Storage ì´ˆê¸°í™”</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    button {
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 5px;
      border: none;
      border-radius: 4px;
      transition: all 0.3s;
    }
    .btn-danger {
      background: #f44336;
      color: white;
    }
    .btn-danger:hover {
      background: #d32f2f;
    }
    .btn-warning {
      background: #ff9800;
      color: white;
    }
    .btn-warning:hover {
      background: #f57c00;
    }
    .btn-primary {
      background: #2196F3;
      color: white;
    }
    .btn-primary:hover {
      background: #0b7dda;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
      font-weight: bold;
    }
    .success { background: #c8e6c9; color: #2e7d32; }
    .info { background: #e3f2fd; color: #1565c0; }
    .warning { background: #fff3e0; color: #e65100; }
    pre {
      background: #f4f4f4;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ—‘ï¸ localStorage ì´ˆê¸°í™” ë„êµ¬</h1>
    
    <div style="margin: 30px 0;">
      <h2>1ë‹¨ê³„: í˜„ì¬ ë°ì´í„° í™•ì¸</h2>
      <button class="btn-primary" onclick="checkStorage()">ğŸ“Š ë°ì´í„° í™•ì¸</button>
      <div id="check-result"></div>
    </div>

    <div style="margin: 30px 0;">
      <h2>2ë‹¨ê³„: ì¤‘ë³µ ë²„ì „ ìˆ˜ì •</h2>
      <p style="color: #666;">ì¤‘ë³µëœ ë²„ì „ ë²ˆí˜¸ë¥¼ ìë™ìœ¼ë¡œ ìˆ˜ì •í•©ë‹ˆë‹¤ (ê¶Œì¥)</p>
      <button class="btn-warning" onclick="fixDuplicateVersions()">ğŸ”§ ì¤‘ë³µ ë²„ì „ ìˆ˜ì •</button>
      <div id="fix-result"></div>
    </div>

    <div style="margin: 30px 0; border-top: 2px solid #ddd; padding-top: 20px;">
      <h2>3ë‹¨ê³„: ì™„ì „ ì´ˆê¸°í™” (ì£¼ì˜!)</h2>
      <p style="color: #d32f2f; font-weight: bold;">âš ï¸ ëª¨ë“  HTML ë²„ì „ íˆìŠ¤í† ë¦¬ê°€ ì‚­ì œë©ë‹ˆë‹¤!</p>
      <p style="color: #666;">ì»´í¬ë„ŒíŠ¸ ì €ì¥ë³¸ì€ MongoDBì— ìˆìœ¼ë¯€ë¡œ ì•ˆì „í•©ë‹ˆë‹¤.</p>
      <button class="btn-danger" onclick="clearVersions()">ğŸ—‘ï¸ ë²„ì „ íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”</button>
      <div id="clear-result"></div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'text-to-html-storage';

    function checkStorage() {
      const result = document.getElementById('check-result');
      const data = localStorage.getItem(STORAGE_KEY);

      if (!data) {
        result.innerHTML = '<div class="result warning">âš ï¸ ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      try {
        const parsed = JSON.parse(data);
        const versions = parsed.state?.htmlVersions || [];

        // ë²„ì „ ë²ˆí˜¸ ì¤‘ë³µ ì²´í¬
        const versionNumbers = versions.map(v => v.version);
        const duplicates = versionNumbers.filter((v, i, arr) => arr.indexOf(v) !== i);
        const uniqueDuplicates = [...new Set(duplicates)];

        result.innerHTML = `
          <div class="result info">
            <p>âœ… ì €ì¥ëœ HTML ë²„ì „: ${versions.length}ê°œ</p>
            <p>í˜„ì¬ ë²„ì „: v${parsed.state?.currentVersion || 'N/A'}</p>
            ${uniqueDuplicates.length > 0 
              ? `<p style="color: #d32f2f;">âš ï¸ ì¤‘ë³µëœ ë²„ì „: ${uniqueDuplicates.join(', ')}</p>` 
              : '<p>âœ… ì¤‘ë³µ ì—†ìŒ</p>'}
          </div>
          <pre>${JSON.stringify({
            versions: versionNumbers,
            currentVersion: parsed.state?.currentVersion
          }, null, 2)}</pre>
        `;
      } catch (error) {
        result.innerHTML = `<div class="result warning">âŒ íŒŒì‹± ì˜¤ë¥˜: ${error.message}</div>`;
      }
    }

    function fixDuplicateVersions() {
      const result = document.getElementById('fix-result');
      const data = localStorage.getItem(STORAGE_KEY);

      if (!data) {
        result.innerHTML = '<div class="result warning">âš ï¸ ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      try {
        const parsed = JSON.parse(data);
        const versions = parsed.state?.htmlVersions || [];

        // ë²„ì „ ë²ˆí˜¸ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì¬í• ë‹¹ (1ë¶€í„° ì‹œì‘)
        const fixedVersions = versions.map((v, i) => ({
          ...v,
          version: i + 1
        }));

        // ìµœì‹  ë²„ì „ìœ¼ë¡œ currentVersion ì„¤ì •
        const newCurrentVersion = fixedVersions.length;

        parsed.state.htmlVersions = fixedVersions;
        parsed.state.currentVersion = newCurrentVersion;

        localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed));

        result.innerHTML = `
          <div class="result success">
            âœ… ìˆ˜ì • ì™„ë£Œ!<br>
            ì´ ${fixedVersions.length}ê°œ ë²„ì „ì„ v1 ~ v${fixedVersions.length}ë¡œ ì¬ì„¤ì •í–ˆìŠµë‹ˆë‹¤.<br>
            í˜„ì¬ ë²„ì „: v${newCurrentVersion}<br><br>
            <strong>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”!</strong>
          </div>
        `;
      } catch (error) {
        result.innerHTML = `<div class="result warning">âŒ ìˆ˜ì • ì‹¤íŒ¨: ${error.message}</div>`;
      }
    }

    function clearVersions() {
      if (!confirm('âš ï¸ ì •ë§ë¡œ ëª¨ë“  HTML ë²„ì „ íˆìŠ¤í† ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n(ì»´í¬ë„ŒíŠ¸ ì €ì¥ë³¸ì€ MongoDBì— ì•ˆì „í•˜ê²Œ ë³´ê´€ë©ë‹ˆë‹¤)')) {
        return;
      }

      const result = document.getElementById('clear-result');
      const data = localStorage.getItem(STORAGE_KEY);

      if (!data) {
        result.innerHTML = '<div class="result warning">âš ï¸ ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      try {
        const parsed = JSON.parse(data);
        const versionCount = parsed.state?.htmlVersions?.length || 0;

        // HTML ë²„ì „ë§Œ ì´ˆê¸°í™” (boxesëŠ” ìœ ì§€)
        parsed.state.htmlVersions = [];
        parsed.state.currentVersion = 0;

        localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed));

        result.innerHTML = `
          <div class="result success">
            âœ… ì´ˆê¸°í™” ì™„ë£Œ!<br>
            ${versionCount}ê°œì˜ HTML ë²„ì „ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.<br><br>
            <strong>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”!</strong>
          </div>
        `;
      } catch (error) {
        result.innerHTML = `<div class="result warning">âŒ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}</div>`;
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ í™•ì¸
    window.onload = () => {
      checkStorage();
    };
  </script>
</body>
</html>
